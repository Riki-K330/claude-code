# CTFチャットボット開発ログ

## 開発期間
2025年6月4日

## 主要な問題と解決過程

### 🔴 問題1: AIが間違った価格を回答
**症状**: ユーザーがアカルボースの価格を質問すると、AIが2,980円、5,460円、7,440円と回答（正しくは5,980円、14,940円、23,880円）

**原因分析**:
1. スプレッドシートからデータが取得されていない
2. 料金プラン表示制限機能のバグ
3. Boolean/文字列比較の問題

**解決プロセス**:

#### ステップ1: データフロー調査
- `testPriceDataRetrieval()`関数を作成してデバッグ
- スプレッドシート接続は正常、データ行数35行確認
- しかし取得プラン数が0となっていることを発見

#### ステップ2: 表示制限設定の問題発見
```
表示制限設定: { 
  showPriorityOnly: false,
  showAllForAcarbose: false,  // ← これがfalseのため表示されない
  showAllForRybelsus: false,
  displayLimit: 10 
}
```

#### ステップ3: 設定値の型不一致問題
- スプレッドシートには`"true"`（文字列）が保存されている
- コードでは`=== "TRUE"`で比較していた
- `String().toLowerCase() === "true"`に修正

#### ステップ4: スプレッドシートの列不足問題
- 期待される列: 10列（表示優先度、表示フラグ含む）
- 実際の列: 8列のみ
- `updateSpreadsheetColumns()`関数で列を自動追加

#### ステップ5: Boolean比較問題
- スプレッドシートから`true`（boolean）が返される
- コードでは`=== "TRUE"`（文字列）で比較
- `=== "TRUE" || === true`に修正

### 🔴 問題2: プロンプトでのデータ使用指示不足
**症状**: 正しいデータをClaude APIに送信しても、AIが独自の価格を生成

**解決方法**:
1. システムプロンプトに厳格な指示を追加
2. プロンプト構築時に明確な注意書きを前後に配置
```
※以下の料金情報のみを使用してください。これ以外の価格は絶対に使用しないでください。
（料金データ）
※上記の料金プラン情報に記載されている金額以外は回答に使用しないでください。
```

## 🛠 実装した機能

### 1. 料金プラン表示制限機能
```javascript
// 薬剤別の表示ルール
if (plan.medicine === "アカルボース") {
  shouldShow = showAllForAcarbose || (showPriorityOnly && plan.priority === 1) || plan.showFlag;
} else if (plan.medicine === "マンジャロ") {
  shouldShow = (showPriorityOnly && plan.priority === 1) || plan.showFlag;
}
```

### 2. スプレッドシート管理機能
- `updateSpreadsheetColumns()`: 不足列の自動追加
- `activateAllPlans()`: 全プランの一括有効化
- `checkActualSpreadsheetData()`: データ確認

### 3. 包括的なデバッグ機能
- `testPriceDataRetrieval()`: 価格データ取得テスト
- `testCompleteDataFlow()`: データフロー全体テスト
- `testSettings()`: 設定値確認
- `updatePlanSettings()`: 設定強制更新

### 4. 動的設定管理の改善
```javascript
// 文字列とBooleanの両方に対応
const showPriorityOnly = String(priorityOnlyValue).toLowerCase() === "true";
const isActive = data[i][7] === "TRUE" || data[i][7] === true;
```

## 📊 修正結果

### Before（問題発生時）
```
取得した料金プラン数: 0
取得したプラン: []
AI回答: 2,980円、5,460円、7,440円（間違った価格）
```

### After（修正後）
```
取得した料金プラン数: 6
取得したプラン: [
  'A001: 50mg×60錠 5980円',
  'A002: 50mg×180錠 14940円', 
  'A003: 50mg×360錠 23880円',
  'A004: 100mg×30錠 5980円',
  'A005: 100mg×90錠 14940円',
  'A006: 100mg×180錠 23880円'
]
AI回答: 正確な価格（5,980円、14,940円、23,880円）
```

## 🔧 修正したファイル

| ファイル | 主な修正内容 |
|---------|-------------|
| `PromptManager.gs` | システムプロンプト強化、Boolean比較修正、デバッグ機能追加 |
| `ClaudeAPI.gs` | プロンプト構築強化、注意書き追加 |
| `ConfigManager.gs` | デフォルト設定値修正（plan_show_priority_only: FALSE） |
| `DataManager.gs` | スプレッドシート管理機能追加（列追加、プラン有効化） |
| `Main.gs` | テスト・デバッグ機能追加 |

## 🎯 学んだ教訓

1. **データ型の一貫性**: スプレッドシートのBoolean値とコードの比較処理
2. **段階的デバッグ**: 各ステップでの詳細ログの重要性
3. **設定管理**: 動的設定の型安全性の確保
4. **プロンプトエンジニアリング**: AIへの明確で厳格な指示の重要性

## 🚀 今後の改善点

1. 型安全性の更なる向上
2. エラーハンドリングの強化
3. パフォーマンスの最適化
4. ユーザーインターフェースの改善

## 📅 開発タイムライン

- 15:00-16:00: 問題発見・原因調査
- 16:00-16:15: デバッグ機能実装
- 16:15-16:25: 設定値問題解決
- 16:25-16:35: 最終テスト・確認完了