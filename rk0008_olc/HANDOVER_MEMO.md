# 引き継ぎメモ - CTF Online Clinic Chatbot

**作成日時**: 2025年6月4日 19:30頃  
**状況**: モデル変更前の引き継ぎ

## 🎯 現在の作業状況

### **完了済み項目**
- ✅ Claude 4モデル対応（Sonnet/Opus）
- ✅ スプレッドシートドロップダウン機能
- ✅ モデル別正確なコスト計算
- ✅ 自動切り替えシステム（トリガー手動設定必要）

### **現在の課題**
⚠️ **Q&A回答に不要な情報が含まれる問題**

#### **具体例**
- 質問：「本人確認について教えて」
- 問題：ビデオ通話での確認など、実際に提供していないサービスが回答に含まれる
- 原因：Q&Aデータは模範回答として正しいが、実際のサービスと乖離

## 📋 次のタスク（優先度順）

### **🔥 高優先度：禁止キーワードフィルター実装**
```javascript
// 実装すべき機能
const PROHIBITED_KEYWORDS = [
  "ビデオ通話",
  "オンライン診療", 
  "顔確認",
  "画面越しに",
  "ビデオ通話での",
  // 実際に提供していないサービス用語
];

// Q&A回答生成時に禁止キーワードを含む文章を除外
```

### **📍 実装場所**
- **ファイル**: `ClaudeAPI.gs` の `buildContextualPrompt()` 関数
- **処理**: Q&Aデータ取得後、回答部分から禁止キーワードを含む文を除外

### **🧪 テスト項目**
1. 「本人確認について教えて」→ ビデオ通話関連の情報が除外されること
2. 他のQ&A項目でも正常に動作すること
3. 必要な情報は残ること

## 🗂️ 重要ファイル

### **主要ファイル**
- `SetupModelSettings.gs`: メインのモデル管理システム
- `ClaudeAPI.gs`: API連携部分（修正対象）
- `DataManager.gs`: Q&Aデータ取得部分

### **設定情報**
- 現在のモデル: Claude 4 Sonnet
- スプレッドシートID: CONFIG.SHEET_ID
- 設定シート: api_modelセルでモデル選択可能

## 🔧 技術的詳細

### **現在の実装状況**
```javascript
// ClaudeAPI.gs の buildContextualPrompt() 内
if (context.relatedQA && context.relatedQA.length > 0) {
  prompt += "\n\n【参考Q&A】\n";
  context.relatedQA.forEach(qa => {
    prompt += `Q: ${qa.question}\nA: ${qa.answer}\n\n`;
  });
}
```

### **必要な修正**
```javascript
// 禁止キーワードフィルター追加
context.relatedQA.forEach(qa => {
  const filteredAnswer = filterProhibitedKeywords(qa.answer);
  prompt += `Q: ${qa.question}\nA: ${filteredAnswer}\n\n`;
});
```

## 📊 システム状態

### **動作確認済み**
- ✅ Claude 4モデルでのAPI通信
- ✅ スプレッドシートでのモデル選択
- ✅ 正確なコスト計算
- ✅ モデル情報の自動更新

### **手動設定必要**
- ⚠️ Google Apps Script トリガー設定
  - 関数: `onModelSettingChange`
  - イベント: 編集時
  - ソース: スプレッドシートから

## 🎯 目標

### **短期目標**
1. 禁止キーワードフィルター実装
2. 「本人確認」回答の最適化
3. 他のQ&A項目の確認

### **長期目標**
- より精密な回答生成システム
- カテゴリ別情報フィルタリング
- 回答品質の自動評価

## 💡 重要な決定事項

1. **Q&Aデータはそのまま使用** - 模範回答として正しい
2. **回答生成時にフィルタリング** - データ側ではなくロジック側で対応
3. **シンプルな実装** - 複雑にせず、禁止キーワード除外のみ

## 📞 連絡事項

**ユーザーからの要望**：
- 実際に提供していないサービス（ビデオ通話等）を回答に含めたくない
- シンプルで正確な回答にしたい
- キーワードベースの除外で十分

---

**次の担当者へ**: 上記の禁止キーワードフィルター実装から開始してください。`ClaudeAPI.gs`の修正が最優先です。