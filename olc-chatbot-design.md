# CTFオンラインクリニック AIチャットボット設計書 v2.0

## 1. システム概要

### 1.1 プロジェクト背景
CTFオンラインクリニックの問い合わせ対応AIチャットボットを、非エンジニアでも簡単に構築・運用できるよう、Google Apps Script (GAS)とGoogle スプレッドシート、Anthropic Claude APIを用いて実装する。

### 1.2 システムアーキテクチャ
```
┌─────────────────┐
│  LINE/Web UI    │
└────────┬────────┘
         │
┌────────▼────────┐
│ Google Apps     │
│   Script        │
├─────────────────┤
│ - Config.gs     │（API設定管理）
│ - ClaudeAPI.gs  │（Claude連携）
│ - PromptMgr.gs  │（プロンプト管理）
│ - DataManager.gs│（データ管理）
│ - UI.gs         │（ユーザーインターフェース）
│ - Testing.gs    │（テスト機能）
│ - CostTracker.gs│（コスト追跡）
└────────┬────────┘
         │
    ┌────▼────┐     ┌─────────────┐
    │Claude API│◄────│Google Sheets│
    └──────────┘     │（知識DB）    │
                     └─────────────┘
```

## 2. 機能要件詳細

### 2.1 事務局AIアシスタントの役割
- **基本設定**
  - 名称: CTFオンラインクリニック事務局
  - 役割: ダイエット薬案内、手続きサポート
  - トーン: 明るく丁寧、適度な絵文字使用（😊✨🙌💊🚚💳）
  - 想定環境: LINE上でのやり取り（改行多め、読みやすさ重視）

### 2.2 取り扱い薬剤情報

| 薬剤名 | 取扱状況 | 主な特徴 | 価格帯 |
|--------|----------|----------|--------|
| アカルボース | ○ | 糖質吸収を穏やかに、50年以上の実績 | 月額3,980円〜 |
| リベルサス | ○ | GLP-1受容体作動薬、朝の空腹時服用 | 要問合せ |
| マンジャロ | ○ | 週1回注射、食欲抑制効果 | 月額19,980円〜 |
| 整腸剤 | ○ | ビオフェルミン＋ミヤBM配合 | 要問合せ |
| フォシーガ | × | 取扱なし | - |
| 防風通聖散 | × | 取扱なし | - |

### 2.3 価格プラン構成

#### アカルボース料金表
```
1ヶ月毎: 50mg×60錠 = 5,980円（税込・送料無料）
3ヶ月毎: 50mg×180錠 = 14,940円（月4,980円）
6ヶ月毎: 50mg×360錠 = 23,880円（月3,980円）
```

#### マンジャロ料金表
```
2.5mg定期:
- 1ヶ月毎: 週1本×4本 = 19,980円
- 2ヶ月毎: 週1本×8本 = 37,980円  
- 3ヶ月毎: 週1本×12本 = 53,980円

5mg定期:
- 3ヶ月毎: 週1本×12本 = 104,400円

特別オファー:
- お試し2週間分: 10,800円 → 9,980円（解約希望者限定）
```

## 3. 技術実装詳細

### 3.1 Google Apps Script構成

#### 必須ファイル構成
```javascript
// Config.gs - 設定管理
const CONFIG = {
  API_KEY: "your-claude-api-key",
  MODEL: "claude-3-opus-20240229",
  SHEET_ID: "spreadsheet-id",
  MAX_TOKENS: 2000,
  TEMPERATURE: 0.7
};

// ClaudeAPI.gs - API連携
function callClaudeAPI(prompt, context) {
  const payload = {
    model: CONFIG.MODEL,
    messages: [
      {role: "system", content: getSystemPrompt()},
      {role: "user", content: prompt}
    ],
    max_tokens: CONFIG.MAX_TOKENS
  };
  
  const options = {
    method: "post",
    headers: {
      "Content-Type": "application/json",
      "x-api-key": CONFIG.API_KEY,
      "anthropic-version": "2023-06-01"
    },
    payload: JSON.stringify(payload)
  };
  
  const response = UrlFetchApp.fetch(
    "https://api.anthropic.com/v1/messages",
    options
  );
  
  return JSON.parse(response.getContentText());
}
```

### 3.2 プロンプト管理システム

```javascript
// PromptManager.gs
function getSystemPrompt() {
  return `あなたは「CTFオンラインクリニック事務局」の担当者として、
オンラインでのダイエット薬やクリニックの利用に関するお問い合わせに対応するAIアシスタントです。

【基本ルール】
1. LINE上でのやり取りを想定し、改行を多めに使用
2. 適度に絵文字を使用（😊✨🙌💊🚚💳）
3. 明るく親しみやすい印象を与える
4. 効果・副作用は医師への相談を促す
5. 体調不良時は医療機関受診を勧める

【取扱薬剤】
- アカルボース：糖質吸収を穏やかに
- リベルサス：GLP-1受容体作動薬
- マンジャロ：週1回注射
- 整腸剤：ビオフェルミン＋ミヤBM

【応答の基本構成】
1. 挨拶＆共感（例：CTFオンラインクリニック事務局です😊）
2. 具体的な情報提供
3. 必要に応じて料金・手続き案内
4. 安心感のある締め＆医師連携案内`;
}
```

### 3.3 知識ベース（スプレッドシート構成）

#### シート1: 薬剤情報
| 薬剤名 | カテゴリ | 特徴 | 服用方法 | 副作用 | 禁忌 |
|--------|----------|------|----------|--------|------|
| アカルボース | 糖吸収抑制薬 | 食後血糖値上昇抑制 | 食事直前 | お腹の張り・ガス | 妊娠中・授乳中 |

#### シート2: 料金プラン
| プランID | 薬剤名 | 期間 | 数量 | 価格 | 備考 |
|----------|--------|------|------|------|------|
| AC_1M | アカルボース | 1ヶ月 | 60錠 | 5,980円 | 送料無料 |

#### シート3: Q&A
| カテゴリ | 質問 | 回答 | 使用頻度 | 最終更新 |
|----------|------|------|----------|----------|
| 服用方法 | 飲み忘れたら？ | 食後に気づいたらスキップ | 高 | 2024/06/03 |

#### シート4: 対話履歴
| 日時 | ユーザーID | 質問 | 回答 | 評価 |
|------|------------|------|------|------|
| 2024/06/03 10:00 | user123 | アカルボースの価格は？ | ... | 満足 |

## 4. 応答フロー設計

### 4.1 基本的な応答パターン

```javascript
// 薬剤情報照会の例
function handleMedicineInquiry(medicine) {
  const info = getMedicineInfo(medicine);
  return `CTFオンラインクリニック事務局です😊
お問い合わせありがとうございます✨

${medicine}について詳しくご説明しますね💊

【特徴】
${info.features}

【服用方法】
${info.dosage}

【一般的な副作用】
${info.sideEffects}
※個人差がありますので、詳しくは医師にご相談ください😌

ご不明な点がございましたら、
お気軽にお問い合わせくださいませ💌`;
}
```

### 4.2 意図分類と応答マッピング

| 意図カテゴリ | キーワード例 | 応答タイプ |
|-------------|-------------|-----------|
| 薬剤情報 | アカルボース、効果、副作用 | 薬剤詳細＋医師相談促進 |
| 料金確認 | 価格、いくら、料金 | 料金表提示＋プラン比較 |
| 手続き | 解約、支払い、変更 | 手順説明＋期限案内 |
| 健康相談 | 体調不良、心配、大丈夫？ | 医療機関受診勧奨 |

## 5. データ管理とセキュリティ

### 5.1 個人情報保護
```javascript
// DataManager.gs - 個人情報マスキング
function maskPersonalInfo(text) {
  // 電話番号のマスキング
  text = text.replace(/\d{3,4}-\d{3,4}-\d{4}/g, "***-****-****");
  // メールアドレスのマスキング
  text = text.replace(/[\w\.\-]+@[\w\.\-]+/g, "****@****.***");
  return text;
}
```

### 5.2 アクセス制御
- スプレッドシートの共有設定を制限
- APIキーの環境変数管理
- 定期的なアクセスログ監査

## 6. コスト管理

### 6.1 API使用量追跡
```javascript
// CostTracker.gs
function trackAPIUsage(inputTokens, outputTokens) {
  const sheet = getSheet("API_Usage");
  const timestamp = new Date();
  const cost = calculateCost(inputTokens, outputTokens);
  
  sheet.appendRow([
    timestamp,
    inputTokens,
    outputTokens,
    cost,
    CONFIG.MODEL
  ]);
  
  // 月次コストアラート
  if (getMonthlyTotal() > MONTHLY_BUDGET) {
    sendCostAlert();
  }
}
```

### 6.2 コスト最適化戦略
- よくある質問のキャッシュ化
- 応答長の最適化
- ピーク時間帯の把握と対策

## 7. 運用・保守計画

### 7.1 日次運用タスク
- [ ] エラーログ確認
- [ ] API使用量チェック
- [ ] 未回答質問の確認

### 7.2 週次改善サイクル
1. **月曜**: 前週の対話ログ分析
2. **火曜**: Q&Aデータベース更新
3. **水曜**: プロンプト調整
4. **木曜**: テスト実施
5. **金曜**: 改善効果測定

### 7.3 月次レビュー項目
- 全体的な応答精度
- ユーザー満足度
- コスト効率
- 新機能の必要性検討

## 8. KPI設定と測定

| KPI | 目標値 | 測定方法 | 頻度 |
|-----|--------|----------|------|
| 応答精度 | 95%以上 | サンプリング評価 | 週次 |
| 応答速度 | 3秒以内 | システムログ | リアルタイム |
| 問い合わせ解決率 | 80%以上 | フォローアップ調査 | 月次 |
| ユーザー満足度 | 4.5/5.0以上 | アンケート | 月次 |
| 月間APIコスト | 5万円以下 | 使用量集計 | 月次 |

## 9. 実装ロードマップ

### Phase 1: 基本機能実装（1週間）
- [x] GAS環境セットアップ
- [x] Claude API接続
- [x] 基本的な問い合わせ応答
- [ ] スプレッドシートDB構築

### Phase 2: 機能拡充（2週間）
- [ ] 薬剤情報の詳細応答
- [ ] 料金プラン案内
- [ ] 手続きサポート機能
- [ ] エラーハンドリング

### Phase 3: 最適化（1週間）
- [ ] 応答品質向上
- [ ] パフォーマンス最適化
- [ ] コスト最適化
- [ ] 運用ドキュメント整備

### Phase 4: 本番運用（継続）
- [ ] 24時間監視体制
- [ ] 定期的な改善
- [ ] ユーザーフィードバック反映

## 10. リスク管理

### 10.1 技術的リスク
| リスク | 影響度 | 対策 |
|--------|--------|------|
| API障害 | 高 | フォールバック応答準備 |
| コスト超過 | 中 | 使用量アラート設定 |
| 誤情報提供 | 高 | 医療監修体制確立 |

### 10.2 運用リスク
- 夜間・休日対応の明確化
- エスカレーションフロー確立
- 定期的なバックアップ

---

*この設計書は2024年6月3日時点の情報に基づいており、実装の進捗に応じて継続的に更新されます。*